# **å°† Promptflow æ·»åŠ åˆ° Visual Studio Code æ’ä»¶**

åœ¨ Copilot Stack ä¸­è§£å†³é—®é¢˜çš„å…³é”®æ˜¯æç¤ºã€‚ æˆ‘ä»¬åœ¨å‰ç«¯æœ‰ Promptï¼Œå®ƒå¯ä»¥æ˜¯è¯¸å¦‚â€œå¸®æˆ‘æå–è¿™æ®µä»£ç ï¼Œåˆ†æå®ƒï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º Pythonâ€ä¹‹ç±»çš„æŒ‡ä»¤ç»„åˆã€‚ æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Semantic Kernelçš„Plannerå°†å…¶åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼šä»£ç æå–ã€åˆ†æã€è½¬æ¢ä¸ºPythonã€‚ è¿™ä¸‰ä¸ªæ­¥éª¤ä¸­çš„æ¯ä¸€ä¸ªéƒ½åŒ…å«ä¸€ä¸ªç®€å•çš„æµç¨‹ã€‚ æˆ‘ä»¬æœ‰å¤§é‡çš„Flowsæ¥è§£å†³åç«¯åº”ç”¨ä¸­çš„ä¸šåŠ¡é—®é¢˜ã€‚ é€šå¸¸è¿™äº›æµç¨‹ç”±å›ºå®šæç¤ºç»„æˆã€‚ å¦‚æœæˆ‘ä»¬å°è¯•ç”¨å¾®æœåŠ¡æ¥æ‹†è§£å®ƒï¼Œå°±ä¼šå‘ç°æœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„ã€‚

é™¤äº†Semantic Kernelæ¡†æ¶ä¹‹å¤–ï¼Œå¾®è½¯è¿˜å‘å¸ƒäº†Promptflowã€‚ åŠæ—¶è§£å†³æ˜¯è§£å†³é—®é¢˜çš„å…³é”®ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ Promptflow æ¥æ ‡å‡†åŒ–ç›¸å…³å†…å®¹ã€‚

## **PromptFlow**

Prompt flow æ˜¯ä¸€å¥—å¼€å‘å·¥å…·ï¼Œæ—¨åœ¨ç®€åŒ–åŸºäº LLM çš„äººå·¥æ™ºèƒ½åº”ç”¨ç¨‹åºçš„ç«¯åˆ°ç«¯å¼€å‘å‘¨æœŸï¼Œä»æ„æ€ã€åŸå‹è®¾è®¡ã€æµ‹è¯•ã€è¯„ä¼°åˆ°ç”Ÿäº§éƒ¨ç½²å’Œç›‘æ§ã€‚ å®ƒä½¿å³æ—¶å·¥ç¨‹å˜å¾—æ›´åŠ å®¹æ˜“ï¼Œå¹¶ä½¿æ‚¨èƒ½å¤Ÿæ„å»ºå…·æœ‰ç”Ÿäº§è´¨é‡çš„ LLM åº”ç”¨ç¨‹åºã€‚

ä»¥ä¸Šæ–‡å­—æ¥è‡ªPromptFlowæ–‡æ¡£ï¼ˆhttps://microsoft.github.io/promptflow/ï¼‰ã€‚ ä»¥æˆ‘çš„ç†è§£ï¼ŒPromptflowæ›´é€‚åˆåŸºäºåç«¯çš„ä¸šåŠ¡é€»è¾‘ã€‚

æˆ‘ä»¬è½¦é—´çš„ä¼ä¸šå‰¯é©¾é©¶å·²ç»æˆå‹ï¼Œä½†å¯¹äºä¼ä¸šæ¥è¯´è¿˜è¿œè¿œä¸å¤Ÿã€‚ æ¯•ç«Ÿä¼ä¸šå¯ä»¥æ²Ÿé€šæ–‡æ¡£ã€ç”Ÿæˆæ–‡æ¡£ã€æ‹¥æœ‰è‡ªå·±çš„ç¼–ç é£æ ¼ï¼Œè¿™äº›éƒ½å¯ä»¥é€šè¿‡å®šåˆ¶æ¥å®Œæˆã€‚ åœ¨ä¸Šä¸€ä¸ªç»ƒä¹ ä¸­ï¼Œæˆ‘ä»¬åœ¨æœ¬åœ°æ”¾ç½®äº†ä¸€äº›Promptå¤„ç†ï¼Œä½†æ˜¯é€šè¿‡Promptflowæˆ‘ä»¬å¯ä»¥ä½¿ç”¨äº‘åŸç”Ÿæ–¹æ³•æ¥å®Œæˆæ›´å¤šæ“ä½œã€‚

## **ä»¥äº‘åŸç”Ÿæ–¹å¼æ„å»ºæ–‡æ¡£èŠå¤©**

Promptflow ç°åœ¨ä¸ä»…é™äº Azureï¼Œè¿˜å¯ä»¥åœ¨æœ¬åœ°å’Œå®¹å™¨ä¸­ä½¿ç”¨ï¼Œè¿™æ„å‘³ç€å®ƒæ›´åŠ çµæ´»ã€‚ æˆ‘ä»¬å¯ä»¥æ›´åŠ ä¸“æ³¨äºå‘å±•ã€‚

å®‰è£… Promptflow éå¸¸ç®€å•ã€‚ æ‚¨å¯ä»¥å®‰è£… Promptflow for Visual Studio Code çš„æ‰©å±•å¹¶é€‰æ‹©â€œå®‰è£…ä¾èµ–é¡¹â€ã€‚ å¯ä»¥çœ‹åˆ°éå¸¸æ¸…æ™°çš„å®‰è£…è¯´æ˜ã€‚ æˆ‘è¿™é‡Œå°±ä¸ä¸€ä¸€æè¿°äº†ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªå‡†å¤‡å·¥ä½œã€‚ æ‚¨å¯ä»¥å‚è€ƒæˆ‘çš„Microsoft Fabricåšå®¢é¦–å…ˆä½¿ç”¨SKå°†çŸ¥è¯†å¯¼å…¥å’Œæå–åˆ°Microsoft Cognitive Searchä¸­ã€‚ ï¼ˆhttps://blog.fabric.microsoft.com/en-us/blog/use-semantic-kernel-with-lakehouse-in-microsoft-fabricï¼‰

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Chatflow ã€‚

1. åˆ›å»º ChatFlow


![image](/imgs/03/01.png)

2. å»ºç«‹é“¾æ¥

Promptflow æ”¯æŒä¸åŒçš„é“¾æ¥ã€‚ æ­¤å¤„éœ€è¦é…ç½® Azure OpenAI è¿æ¥å’Œ Azure è®¤çŸ¥æœç´¢è¿æ¥ã€‚ è¿™é‡Œåªéœ€è¦æ·»åŠ é“¾æ¥å³å¯ã€‚ å¯†é’¥åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥ã€‚


![image](/imgs/03/02.png)

3. äº†è§£ Promptflow é¡¹ç›®çš„ç»“æ„



![image](/imgs/03/03.png)


Promptflowçš„ä¸»è¦æ–‡ä»¶ï¼š

a. .py - ç”¨äºä¸é€»è¾‘å’Œ LLM äº¤äº’çš„ Python æ–‡ä»¶

b. .jinja2 - è¿™æ˜¯æç¤ºçš„è®¾ç½®ã€‚ é‡Œé¢å¯ä»¥å†™Promptï¼Œæ¨¡å‹æ•™è‚²æ—¶ä¼šç»‘å®šã€‚

c. flow.dag.yaml - è¿™ä¸ªæ–‡ä»¶éå¸¸æœ‰è¶£ã€‚ æ‚¨å¯ä»¥è®¾ç½®æ‰§è¡Œæµç¨‹çš„é¡ºåºï¼Œå¹¶ä¸”å¯ä»¥é€‰æ‹©ä»¥å¯è§†åŒ–å½¢å¼æŸ¥çœ‹æ–‡ä»¶ã€‚

å¦‚æœä½ æƒ³äº†è§£æ›´å¤šï¼Œå¯ä»¥æŸ¥çœ‹https://microsoft.github.io/promptflow/how-to-guides/develop-a-flow/develop-standard-flow.html



4. å»ºè®®æ‚¨ç›´æ¥æ‰“å¼€ç¤ºä¾‹é¡¹ç›® [åœ¨æ­¤ä¸‹è½½](./code/03/vscode-chatflow)
  å¹¶ç›´æ¥è¿è¡Œå³å¯æŸ¥çœ‹ã€‚ å½“ç„¶ï¼Œæ‚¨å¿…é¡»ç¡®ä¿æ‚¨çš„è¿æ¥é…ç½®æ­£ç¡®ã€‚ ï¼ˆä¸è¦å¿˜è®°é¦–å…ˆè¿è¡Œ pip install -r request.txtï¼‰

5. åœ¨flow.dag.yamlä¸­å¯ä»¥é€‰æ‹©runã€debugã€deployï¼Œå®Œæˆpromptflowè°ƒè¯•ã€‚

![image](/imgs/03/04.png)

6. æœ¬åœ°è¿è¡Œå°±å¯ä»¥çœ‹åˆ°èŠå¤©ç•Œé¢


![image](/imgs/03/05.png)

7. é€šè¿‡ http://localhost:8080/swagger.json äº†è§£è°ƒç”¨æ¥å£

![image](/imgs/03/06.png)

8. æ·»åŠ åˆ° Visual Studio Code æ’ä»¶

å®‰è£… note-fetch

```bash

npm install node-fetch@2    


```

æ›´æ–° copilotenterprise.js 

```js

const fetch = require('node-fetch');

.........

async function RunPlanner(qa){

    const myUrl = 'http://127.0.0.1:8080/score';
    const myData = {"question":qa};
  
    const response = await fetch(myUrl, {
      method: 'POST',
      body: JSON.stringify(myData),
    }).then((response) => response.json());
  
    //console.log(response);

    return response.answer;


}


```

æ›´æ”¹ copilotenterprise.js 


```js

const {RunInSemanticKernel,RunPlanner} = require('./enterprisecopilot.js');

.........


	let webViewProvider={
			resolveWebviewView: (_webviewView , _webviewContex) => {
				_webviewView.webview.options={enableScripts:true};
				this.webView = _webviewView;
				this.webView.webview.html = initChatViewContent(this.webView,extensionURL);
				this.webView.webview.onDidReceiveMessage( async message => {
					switch (message.type) {
						case 'addQA':
							
							const result =  await RunPlanner(message.value); //await RunInSemanticKernel(message.value,"Translate");
							const strQA = 'ğŸ§‘:  <br/>' + message.value + '<br/>' + 'ğŸ¤–: <br/>'  + result + '<br/>';
							this.webView.webview.postMessage({ type: 'addQA', value:  strQA });
							break;
					}
				}, undefined, context.subscriptions);
			}
	};


```

è¿è¡Œ


![image](/imgs/03/07.png)

å¤ªæ£’äº†ï¼Œæ‚¨å·²ç»å¯ä»¥åšæ›´å¤šçš„å®šåˆ¶å·¥ä½œäº†ã€‚ å½“ç„¶ï¼Œè¿™ä¸ªå·¥ä½œåŠåªæ˜¯ä½ çš„ç¬¬ä¸€æ­¥ï¼Œæˆ–è€…æˆ‘ä»¬ä¸ä»…ä»…æ˜¯ä½¿ç”¨Semantic Kernelï¼Œä¸Promptflowç»“åˆè¿˜æœ‰æ›´å¤šçš„å¯èƒ½æ€§ã€‚


